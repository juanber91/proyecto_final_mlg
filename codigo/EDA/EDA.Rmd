---
title: "EDA_PROY_FIN"
author: "Alejandro Nivón Ruiz"
date: "December 15, 2019"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(rpivotTable) 
library(knitr)
library(kableExtra)
knitr::opts_chunk$set(echo = TRUE, root.dir = "~/Documentos/RgrAvn/ProyectoFinal/proyecto_final_mlg")
```

## BASES DE DATOS

Para el análisis explortatorio de datos se incorporará la información poblacional por estado y municipio de los años que estudia la base.

Los censos poblacionales se llevan a cabo cada 10 años y los conteos intercensales 5 años después de cada censo, por lo que se tienen estimaciones poblacionales por municipio para los años 2005 y 2010. 
Para estimar la población interanual hasta el año 2011 se realizó una estimación lineal anual tomando en cuenta como puntos extremos ambos conteos censales.

El fin de contar con las estimaciones anuales será el de poder estandarizar los conteos de ejecuciones por densidad poblacional y de esta forma poder hacer comparable la información de estado a estado o de municipio a municipio y así tener una percepción mejor del nivel de riesgo que conlleva cada sector geográfico.


```{r cars, echo=FALSE}
setwd("~/Documentos/RgrAvn/ProyectoFinal/proyecto_final_mlg")
pob <- read.csv("datos/Proyeccion de Poblacion/Población por Municipio 2005 - 2011.csv")
pob %<>% 
  select(ESTADO = cve_ent, estado = nom_ent, cve_mun, contains('pob_ent')) %>% 
  mutate(ESTADO = as.character(ESTADO)) %>% 
  gather(AÑO, poblacion, contains('pob_ent')) %>% 
  mutate(AÑO = parse_number(str_remove(AÑO, '\\.'))) %>% 
  group_by(ESTADO, estado, AÑO) %>% 
  summarise(poblacion = sum(poblacion)) %>% 
  ungroup()

narco <- read.csv('datos/limpios.csv')

narco_mensual <- narco %>%
  filter(AÑO != 2006) %>% 
  group_by(ESTADO, AÑO, MES) %>% 
  summarise_at(vars(EJF:cartel_otro), ~sum(., na.rm = T)) %>% 
  ungroup() %>% 
  mutate(ESTADO = as.character(ESTADO))
```

## Including Plots

```{r pressure, echo=FALSE}
hist1 <- narco_mensual %>% select(ESTADO, AÑO, EJ) %>% group_by(AÑO, ESTADO) %>%
  summarise(EJ = sum(EJ)) %>% merge(pob, by = c("ESTADO", "AÑO"))
hist1 <- hist1 %>% transform(AÑO = as.factor(AÑO))
ggplot(hist1, aes(x = log(poblacion), y = log(EJ), color = AÑO)) + geom_point() + scale_colour_brewer(palette = "Dark2") + ggtitle("Relación Población vs Ejecuciones por estado 2007 - 2011") + theme(plot.title = element_text(hjust = 0.5)) +  stat_smooth(method="lm", formula = y ~ x + I(x^2), alpha = 0.2, size = 0.5, color = "gray30")
```
  
Se puede notar aquí que los estados con mayor población tienden a tener una mayor cantidad de ejecuciones, por lo que la variable a analizar será la tasas de ejecuciones por cada millón de habitantes por estado.

```{r, echo=FALSE}
hist2 <- hist1 %>% mutate(tasa = EJ/poblacion*1000000)
ggplot(hist2, aes(x = log(poblacion), y = log(tasa), color = AÑO)) + geom_point() + scale_colour_brewer(palette = "Dark2") + ggtitle("Relación Población vs tasa de ejecuciones por cada millón de habitantes por estado 2007 - 2011") + theme(plot.title = element_text(hjust = 0.5)) + theme(plot.title = element_text(size = 10)) +  stat_smooth(method="lm", formula = y ~ x + I(x^2), alpha = 0.2, size = 0.5, color = "gray30")
```

No hay una relación tan clara entre el tamaño de la población estatal y la tendencia en las tasas de ejecuciones por cada millón de habitantes.
Por lo que se decidió que esta avariable sea la que se modelará.

Comenzando la evaluación frecuentista por año de la tasa de ejecución, se puede observar que al pasar de los años las tasas van siendo en promedio más altas a nivel estado, teniendo mayores varianzas y observaciones atípicas más severas.

```{r, echo = FALSE}
ggplot(hist2, aes(x=AÑO, y=tasa)) + geom_boxplot() + ggtitle("Distribución tasa estatal de ejecuciones por cada millón de habitantes por año") + theme(plot.title = element_text(size = 13)) + theme(plot.title = element_text(hjust = 0.5)) + ylim(c(0, 300))
```

El top 10 de estados con tasas de ejecuciones más altas por año son:

```{r, echo = FALSE, warning=FALSE}
top10 <- data_frame()
for (i in 2007:2011){
  aux <- hist2 %>% filter(AÑO == i) %>% arrange(desc(tasa))
  top10 <- top10 %>% rbind(aux[1:10,])
}

top10 <- top10 %>% select(AÑO, estado, tasa)
top10 %>% rpivotTable(rows = "estado", cols = "AÑO", vals = "tasa", width = 1000, height = 800, 
            aggregatorName = "Sum", rendererName = "Col Heatmap")
```
4 estados estuvieron durante los 5 años en el top 10 de estados con mayor tasa de ejecuciones por cada millón de habitantes: Chihuahua, Durango, Sinaloa, Guerrero. Morelos y Baja california aparecen en 4 de los 5 años.

Reduciéndolo a un top 5 durante estos años:

```{r, echo=FALSE}
top5 <- data_frame()
for (i in 2007:2011){
  aux <- hist2 %>% filter(AÑO == i) %>% arrange(desc(tasa))
  top5 <- top5 %>% rbind(aux[1:5,])
}

total <- hist2 %>% select(AÑO, estado, EJ) %>% group_by(AÑO) %>% 
  summarise(Ejecuciones_pais = sum(EJ))
top5 <- top5 %>% select(AÑO, estado, EJ) %>% group_by(AÑO) %>% summarise(Ejecuciones_top5 = sum(EJ)) %>% 
    merge(total)

top5['Proporcion'] <- top5$Ejecuciones_top5/top5$Ejecuciones_pais
kable(top5) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```


```{r}
total
```

